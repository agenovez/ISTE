#include "WiFi.h"
#include "esp_wifi.h"

// Contador global
int deauthCount = 0;

// Estructura de cabecera MAC 802.11
typedef struct {
  unsigned frame_ctrl : 16;
  unsigned duration_id : 16;
  uint8_t addr1[6]; // Destino
  uint8_t addr2[6]; // Transmisor (ATACANTE)
  uint8_t addr3[6]; // BSSID
  unsigned seq_ctrl : 16;
} wifi_ieee80211_mac_hdr_t;

// ----------------------------
// Función para imprimir MAC
// ----------------------------
void printMAC(const uint8_t *mac) {
  Serial.printf("%02X:%02X:%02X:%02X:%02X:%02X",
                mac[0], mac[1], mac[2],
                mac[3], mac[4], mac[5]);
}

// ----------------------------
// Callback del modo promiscuo
// ----------------------------
void wifi_sniffer_packet_handler(void* buff, wifi_promiscuous_pkt_type_t type) {
  const wifi_promiscuous_pkt_t *ppkt = (wifi_promiscuous_pkt_t *)buff;
  const wifi_ieee80211_mac_hdr_t *hdr = (wifi_ieee80211_mac_hdr_t *)ppkt->payload;

  uint16_t fc = hdr->frame_ctrl;

  uint8_t frame_type = (fc & 0x000C) >> 2;   // tipo de trama
  uint8_t frame_subtype = (fc & 0x00F0) >> 4; // subtipo

  // Detectar tramas DeAuth (Subtype 12 ó 0xC)
  if (frame_type == 0 && frame_subtype == 12) {
    deauthCount++;

    Serial.printf("\n⚠️ ¡Trama DeAuth detectada! Total: %d\n", deauthCount);

    Serial.print("   Atacante (addr2): ");
    printMAC(hdr->addr2);
    Serial.println();

    Serial.print("   Destino (addr1):  ");
    printMAC(hdr->addr1);
    Serial.println();

    Serial.print("   BSSID (addr3):    ");
    printMAC(hdr->addr3);
    Serial.println();
  }
}

// ----------------------------
// Setup
// ----------------------------
void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\n=== Detector Anti-DeAuth (ESP32) ===");
  Serial.println("Inicializando WiFi en modo promiscuo...");

  WiFi.mode(WIFI_STA);
  WiFi.disconnect();

  // Establecer máscara de filtros (capturar TODO)
  wifi_promiscuous_filter_t filter = {
    .filter_mask = WIFI_PROMIS_FILTER_MASK_ALL
  };

  esp_wifi_set_promiscuous_filter(&filter);

  // Callback
  esp_wifi_set_promiscuous_rx_cb(&wifi_sniffer_packet_handler);

  // Activar modo promiscuo
  esp_wifi_set_promiscuous(true);

  Serial.println("Modo promiscuo ACTIVADO. Escuchando tramas 802.11...\n");
}

// ----------------------------
// Loop
// ----------------------------
void loop() {
  static unsigned long last = 0;

  if (millis() - last > 5000) {
    last = millis();
    Serial.printf("Resumen → Tramas DeAuth detectadas: %d\n", deauthCount);
  }
}
